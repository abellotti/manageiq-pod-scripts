if [ -z "$DOCKER_HOST" ]
then
  echo "Docker not setup on Minishift"
elif [ -n "$(oc get pods | grep httpd-authconfig)" ]
then
  echo "ManageIQ Httpd AuthConfig Pod currently exist" 
else
  cd $HOME/pods
  if [ ! -d container-httpd-authconfig/templates ]
  then
    echo "Missing container-httpd ManageIQ Pod templates symlink"
  else
    TEMPLATE_DIR=`pwd`/container-httpd-authconfig/templates
    export TEMPLATE_DIR

    echo "TEMPLATE_DIR=${TEMPLATE_DIR}"

    if [ "${1}" = "-f" ]
    then
      if [ -n "$(oc get templates | grep manageiq-httpd-authconfig)" ]
      then
        echo "Deleting ManageIQ manageiq-httpd-authconfig Template ..."
        oc delete templates/manageiq-httpd-authconfig
      fi
      
      oc login $(minishift ip):8443 -u system:admin

      if [ -n "$(oc get serviceaccounts | grep miq-httpd-authconfig)" ]
      then
        echo "Deleting miq-httpd-authconfig service account ..."
        oc delete serviceaccounts/miq-httpd-authconfig
      fi

      if [ ! -n "$(oc get scc | grep miq-sysadmin)" ]
      then
        echo "Creating miq-sysadmin SCC ..."
        oc create -f $TEMPLATE_DIR/miq-scc-sysadmin.yaml
      fi

      echo "Setting miq-sysadmin SCC to user miq-httpd-authconfig ..."
      oc adm policy add-scc-to-user miq-sysadmin system:serviceaccount:$OC_PROJECT:miq-httpd-authconfig
      oc describe scc miq-sysadmin | grep Users
      echo "Creating manageiq-httpd-authconfig Template ..."
      oc create -f $TEMPLATE_DIR/miq-httpd-authconfig-template.yaml
      oc login $(minishift ip):8443 -u developer -p developer
    fi

    oc login $(minishift ip):8443 -u developer -p developer
    oc new-app --template=manageiq-httpd-authconfig
  fi
fi
